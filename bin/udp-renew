#!/bin/bash

DB="/etc/udp-zivpn/users.db"

if [ ! -f "$DB" ]; then
  echo "Database user tidak ditemukan"
  exit 1
fi

read -p "Username : " USER
read -p "Tambah hari (angka): " DAYS

# validasi input
if ! [[ "$DAYS" =~ ^[0-9]+$ ]]; then
  echo "Jumlah hari tidak valid"
  exit 1
fi

# cek user ada
if ! grep -qw "^$USER" "$DB"; then
  echo "User tidak ditemukan"
  exit 1
fi

TMP=$(mktemp)

while read -r user exp used max; do
  if [ "$user" == "$USER" ]; then
    # jika sudah expired, hitung dari hari ini
    NOW_TS=$(date +%s)
    EXP_TS=$(date -d "$exp" +%s 2>/dev/null)

    if [ -z "$EXP_TS" ] || [ "$EXP_TS" -lt "$NOW_TS" ]; then
      NEW_EXP=$(date -d "+$DAYS days" +"%Y-%m-%d %H:%M")
    else
      NEW_EXP=$(date -d "$exp +$DAYS days" +"%Y-%m-%d %H:%M")
    fi

    echo "$user $NEW_EXP $used $max" >> "$TMP"
  else
    echo "$user $exp $used $max" >> "$TMP"
  fi
done < "$DB"

mv "$TMP" "$DB"

echo "==============================="
echo " RENEW USER BERHASIL "
echo "==============================="
echo "Username : $USER"
echo "Tambah   : $DAYS hari"
echo "Expired  : $NEW_EXP"
echo "==============================="

